#!/usr/bin/env perl
use strict;
use lib qw(lib);

use File::Slurp qw( write_file );
use Email::Thread;
use Email::Folder;
use Mail::Thread::Arc;

my $threader = Email::Thread->new( Email::Folder->new('threadtest')->messages );
my $arc = Mail::Thread::Arc->new;
#$Mail::Thread::nosubject = 1;
$threader->thread;

my $i;
for my $thread ($threader->rootset) {
    ++$i;
    my @messages;
    $thread->iterate_down(
        sub {
            my $c = shift;
            return unless $c->message;
            push @messages, $c;
        });

    @messages = sort {
        $arc->date_of( $a ) <=> $arc->date_of( $b )
    } @messages;

    my $svg = $arc->highlight_message( undef )->render( $thread );
    write_file( "thread_$i.svg", $svg->xmlify );

    next;
    my $j;
    for my $message (@messages) {
        my $svg = $arc->highlight_message( $message )->render( $thread );
        ++$j;
        write_file( "thread_$i\_$j.svg", $svg->xmlify );
    }
}
